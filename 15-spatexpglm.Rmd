---
title: "15 - Spatially-explicit Generalized Linear/Additive Models"
author: "Francisco E. Fonturbel"
date: "15/November/2022"
output: 
  html_document:
    includes:
        after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# Including the spatial structure in our models

Organisms in nature are rarely distributed in regular arrangements. We usually found plants or animals forming clusters in high-quality microhabitats or randomly distributed in some areas. Such arrangement pattern is called _spatial structure_ and it is from remarkable importance in ecology. When we collect field data, we may obtain geographic coordinates from our sampling sites / units and therefore conduct sptially-explicit models, including the relative location of each unit as a covariate.

To illustrate this lesson, we will use (again) the data of [Font√∫rbek et al. 2015](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2745.12443).

```{r data}
library(spdep)
library(spatstat)
library(mgcv)
library(nortest)
library(gstat)
library(ncf)
library(mpmcorrelogram)
library(ggplot2)

data<-read.csv("data/11_mistletoe_data.csv", 
                     header=TRUE, 
                     sep=";",
                     dec=".",
                     na.strings="NA")
attach(data)
head(data)

x<-data$UTM_E
y<-data$UTM_N

##Some ggplot2 grooming
My_Theme = theme(
  axis.title.x = element_text(size = 20,face="bold"),
  axis.text.x = element_text(size = 16),
  axis.text.y = element_text(size = 16),
  axis.title.y = element_text(size = 20,face="bold"),
  legend.text = element_text(size = 14),
  legend.title = element_text(size = 14,face="bold"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "white"))
```


## The spatial autocovariate approach

The simplest approach to conduct a spatially-explicit model is to create a new variable upon geographic coordinates (ideally in UTM format) and then including it into the model. The steps for creating this autocovariate are as follows:

```{r acov}
xy<-cbind(x,y)
ac1a<-autocov_dist(crop_size, xy, nbs=1500, style="W", type="one")
plot(ac1a ~ crop_size, pch=16, asp=1)

nb<-dnearneigh(xy, 0, 1500)
lw<-nb2listw(nb, style="W")
ac1b<-lag(lw, crop_size)
all.equal(ac1b, ac1a)
```

And the `glm` model including the autocovariate looks like this:

```{r model1}
glm_cs<-glm(crop_size ~ temp + hum + lum + ac1b, data=data, family="poisson")
summary(glm_cs)
```

Now we will conduct the same model withour the spatial term for comparison purposes:

```{r model2}
glm_cs_s<-glm(crop_size ~ temp + hum + lum, data=data, family="poisson")
summary(glm_cs_s)
```

Comparing model performance:

```{r comp1}
AIC(glm_cs)
AIC(glm_cs_s)
comp1<-anova(glm_cs,glm_cs_s)
comp1
```

So, the spatially-explicit model has a slight improvement in fit compared to the non spatially-explicit model.

## The GAM approach

Taking advantage of GAM models, we can include the X,Y coordinates as a splie term in the model:

```{r model3}
gam_cs<-gam(crop_size ~ temp + hum + lum+s(x,y),data=data,family=poisson)
summary(gam_cs)
AIC(gam_cs)
```

This approach is much easier as we don't need to create a coviate and including coordinates as a spline term largely reduced model's AIC value.

## Final thoughts

GLMM models allow us to include random effects in our GLM models (using all the possible distributions that we learned in the past sessions) to account for covariates, variation sources, and repeated measures. This applies for GAM models as well.


## Session

```{r session, echo=TRUE}
sessionInfo()
```